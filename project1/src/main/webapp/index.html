<!DOCTYPE html>
<html>

<head>
    <title>Pizza app</title>
</head>

<body id="main">

    <h2>Login</h2>
    <h3>Username</h3>
    <input id="username" type="text">
    <h3>Password</h3>
    <input id="password" type="text">
    <button onclick="getPizzaUser()">Login</button>
    <button onclick="registerPizzaUser()">Register</button>

</body>
<script>

    function getPizzaUser() {
        let xhttp = new XMLHttpRequest();
        let username = document.getElementById("username").value;
        let password = document.getElementById("password").value;
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                let puser = JSON.parse(this.responseText);

                console.log(puser);

                if ((puser.username == username) && (puser.password == password)) {
                    getSession();
                }
            }
        }
        xhttp.open("GET", "http://localhost:8080/project1/getPizzaUser.do?username=" + username, true);
        xhttp.send();
    }

    function getSession() {
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                let puser = JSON.parse(this.responseText);

                console.log(puser);
                let header = `welcome ${puser.username} rewards: ${puser.rewards}`
                document.getElementById("main").innerHTML = header

            }
        }
        xhttp.open("GET", "http://localhost:8080/project1/getSession.do", true);
        xhttp.send();
    }

    function registerPizzaUser() {
        document.getElementById("main").innerHTML = `<p id="invalid"></p>
    <h3>Username</h3>
    <input id="username" type="text">

    <h3>Password</h3>
    <input id="password" type="text">

    <button onclick="addPizzaUser()">add PizzaUser</button>`
    }

    function addPizzaUser() {

        let username = document.getElementById("username").value
        let password = document.getElementById("password").value


        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {

                if (this.responseText == 1) {
                    document.getElementById("main").innerHTML =
                        `<h2>Login</h2>
                        <h3>Username</h3>
                        <input id="username" type="text">
                        <h3>Password</h3>
                        <input id="password" type="text">
                        <button onclick="getPizzaUser()">Login</button>
                        <button onclick="registerPizzaUser()">Register</button>`
                }
                else {
                    document.getElementById("invalid").innerHTML = "Invalid username/password"

                }
            }
        };

        xhttp.open("POST",
            "http://localhost:8080/project1/addPizzaUser.do?",
            true);
        xhttp.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhttp.send("username=" + username + "&password=" + password);
    }

</script>

</html>